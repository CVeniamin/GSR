ip addr add dev eth0 10.0.2.65/28
ip link set dev eth0 up
ip addr add dev eth1 10.0.0.129/30
ip link set dev eth1 up
ip addr add dev eth2 10.0.0.17/30
ip link set dev eth2 up
ip addr add dev eth3 10.0.0.133/30
ip link set dev eth3 up
ip addr add dev eth4 10.0.2.81/28
ip link set dev eth4 up
ip addr add dev eth5 192.168.0.1/29
ip link set dev eth5 up
ip route add 192.168.1.0/29 via 10.0.2.83
/etc/init.d/zebra start
/etc/init.d/dhcp3-server start
/etc/init.d/snmpd start
/etc/init.d/inetd start

iptables --flush

WEB_INTERFACE=eth2
USER_INTERFACES=eth0 eth1 eth3
PROXY_ADDR='10.0.2.84'
WEB_ADDR='10.0.2.83'

# Block outgoing HTTP(S) for everything but proxy server
for i in $USER_INTERFACES
 do
  #iptables -t nat -A PREROUTING -i $i -s ! $PROXY_ADDR -p tcp --dport 80 -j DNAT --to $PROXY_ADDR:3128
  #iptables -t nat -A POSTROUTING -o $i -d $PROXY_ADDR -j SNAT --to iptables-box
  #iptables -A FORWARD -d $PROXY_ADDR -i $i -o $i -p tcp --dport 3128 -j ACCEPT
  iptables -t nat -A PREROUTING -i $i -p tcp -m multiport --dports 80,443 -j DNAT --to-destination $PROXY_ADDR:3128
done

# Block all outgoing and incoming traffic for private IPs
iptables -A FORWARD -s 192.168.0.0/16 -o $WEB_INTERFACE -j DROP
iptables -A FORWARD -d 192.168.0.0/16 -i $WEB_INTERFACE -j DROP

# Protect services from access from Internet
iptables -A FORWARD -d $PROXY_ADDR --dport 3128 -i $WEB_INTERFACE -j DROP

# Open public services for access from Internet
iptables -A FORWARD -p tcp -d $WEB_ADDR -m multiport --dports 80,443 -j ACCEPT # HTTP(S)
iptables -A FORWARD -p tcp -d $WEB_ADDR -m multiport --dports 80,443 -j ACCEPT # SMTP IMAP DNS SSH VPN


#Bloquear acesso do exterior para maquinas de IP privado
iptables -A FORWARD -i eth2 -d 192.168.0.0/28 -j DROP

#Evitar IP spoofing
iptables -A FORWARD -i eth2 -s 192.168.0.0/28 -j DROP
iptables -A FORWARD -i eth2 -s 10.0.2.64/26 -j DROP
iptables -A FORWARD -i eth2 -s 10.0.0.128/26 -j DROP

#Permitir a internet acesso aos Servi√ßos Administrativos Lisboa
iptables -A FORWARD -s 10.0.2.64/28 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A FORWARD -d 10.0.2.64/28 -m state --state ESTABLISHED -j ACCEPT
iptables -A FORWARD -i eth2 -d 10.0.2.64/28 -m state --state NEW -j DROP

#Permitir a internet acesso aos visitantes Escritorio Lisboa
iptables -A FORWARD -s 10.0.2.96/28 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A FORWARD -d 10.0.2.96/28 -m state --state ESTABLISHED -j ACCEPT
iptables -A FORWARD -i eth2 -d 10.0.2.96/28 -m state --state NEW -j DROP

#Permitir a internet acesso ao visitantes Escritorio Porto
iptables -A FORWARD -s 10.0.2.112/28 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A FORWARD -d 10.0.2.112/28 -m state --state ESTABLISHED -j ACCEPT
iptables -A FORWARD -i eth2 -d 10.0.2.112/28 -m state --state NEW -j DROP


#trafego para dnsEmail
iptables -A FORWARD -i eth2 -d 10.0.2.82 -p tcp --dport 80 -j ACCEPT #HTTP
iptables -A FORWARD -i eth2 -d 10.0.2.82 -p tcp --dport 443 -j ACCEPT #HTTPS
iptables -A FORWARD -i eth2 -d 10.0.2.82 -p tcp --dport 25 -j ACCEPT #SMPT
iptables -A FORWARD -i eth2 -d 10.0.2.82 -p tcp --dport 143 -j ACCEPT #IMAP
iptables -A FORWARD -i eth2 -d 10.0.2.82 -p udp --dport 53 -j ACCEPT #DNS
iptables -A FORWARD -i eth2 -d 10.0.2.82 -p tcp --dport 53 -j ACCEPT #DNS
iptables -A FORWARD -i eth2 -d 10.0.2.82 -p tcp --dport 22 -j ACCEPT #SSH
iptables -A FORWARD -i eth2 -s 10.0.2.82 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A FORWARD -i eth2 -d 10.0.2.82 -m state --state ESTABLISHED -j ACCEPT
iptables -A FORWARD -i eth2 -d 10.0.2.82 -j DROP #Restante

#trafego para dnsHttp
iptables -A FORWARD -i eth2 -d 10.0.2.83 -p tcp --dport 80 -j ACCEPT #HTTP
iptables -A FORWARD -i eth2 -d 10.0.2.83 -p tcp --dport 443 -j ACCEPT #HTTPS
iptables -A FORWARD -i eth2 -d 10.0.2.83 -p tcp --dport 25 -j ACCEPT #SMPT
iptables -A FORWARD -i eth2 -d 10.0.2.83 -p tcp --dport 143 -j ACCEPT #IMAP
iptables -A FORWARD -i eth2 -d 10.0.2.83 -p udp --dport 53 -j ACCEPT #DNS
iptables -A FORWARD -i eth2 -d 10.0.2.83 -p tcp --dport 53 -j ACCEPT #DNS
iptables -A FORWARD -i eth2 -d 10.0.2.83 -p tcp --dport 22 -j ACCEPT #SSH
#iptables -A FORWARD -i eth2 -d 10.0.2.83 -p tcp --dport 1194 -j ACCEPT #VPN
iptables -A FORWARD -i eth2 -d 10.0.2.83 -p udp --dport 1194 -j ACCEPT #VPN
iptables -A FORWARD -i eth2 -s 10.0.2.83 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A FORWARD -i eth2 -d 10.0.2.83 -m state --state ESTABLISHED -j ACCEPT
iptables -A FORWARD -i eth2 -d 10.0.2.83 -j DROP #Restante
